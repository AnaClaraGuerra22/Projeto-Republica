<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Estatísticas - República do 804</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="republica-body">
    <nav class="glass-nav">
        <div class="nav-links">
            <a href="/">Cálculo</a>
            <a href="/galeria">Momentos</a>
            <a href="/moradoras">Moradoras</a>
            <a href="/historico">Histórico</a>
            <a href="/estatisticas" class="active">Estatísticas</a>
        </div>
    </nav>

    <main class="container">
        <section class="glass-card">
            <h2 class="section-title">Análise de Gastos</h2>

            <div class="filter-box" style="text-align: right; margin-bottom: 20px;">
                <label for="periodo" style="font-size: 0.8rem; text-transform: uppercase;">Visualizar:</label>
                <select id="periodo" onchange="filtrarGrafico()" style="padding: 5px; border: 1px solid var(--secondary-color); background: white; font-family: 'Georgia', serif;">
                    <option value="3">Últimos 3 meses</option>
                    <option value="6">Últimos 6 meses</option>
                    <option value="12" selected>Último ano</option>
                </select>
            </div>
            
            <div class="chart-container" style="margin-bottom: 60px; height: 300px;">
                <h3 style="text-align: center; color: var(--accent-color); font-size: 1rem;">Variação da Conta de Luz</h3>
                <canvas id="chartLuz"></canvas>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--secondary-color); margin: 40px 0;">

            <div class="chart-container" style="height: 400px;">
                <h3 style="text-align: center; color: var(--accent-color); font-size: 1rem;">Pagamentos Individuais</h3>
                <canvas id="chartMoradoras"></canvas>
            </div>
        </section>
    </main>

    <script>
        let graficoLuz, graficoMoradoras;
        const dadosLuzBase = <%- JSON.stringify(dadosLuz) %>;
        const dadosPagamentosBase = <%- JSON.stringify(dadosPagamentos) %>;

        function renderizarGraficos(mesesFiltradosLuz, mesesFiltradosPagamentos) {
            if (graficoLuz) graficoLuz.destroy();
            if (graficoMoradoras) graficoMoradoras.destroy();

            const ctxLuz = document.getElementById('chartLuz').getContext('2d');
            graficoLuz = new Chart(ctxLuz, {
                type: 'line',
                data: {
                    labels: mesesFiltradosLuz.map(d => d.mes_referencia),
                    datasets: [{
                        label: 'Luz (R$)',
                        data: mesesFiltradosLuz.map(d => d.valor_luz),
                        borderColor: '#8b735b',
                        backgroundColor: 'rgba(139, 115, 91, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const mesesLabels = [...new Set(mesesFiltradosPagamentos.map(d => d.mes_referencia))];
            const nomes = ["ANA", "EDUARDA", "JULIA", "MENINAS"];
            const cores = ['#332f2c', '#8b735b', '#d7d1c2', '#a69f8d'];

            const datasets = nomes.map((nome, i) => ({
                label: nome,
                data: mesesLabels.map(m => {
                    const r = mesesFiltradosPagamentos.find(d => d.nome === nome && d.mes_referencia === m);
                    return r ? r.valor_pago : null;
                }),
                borderColor: cores[i],
                backgroundColor: cores[i],
                tension: 0.2
            }));

            const ctxMor = document.getElementById('chartMoradoras').getContext('2d');
            graficoMoradoras = new Chart(ctxMor, {
                type: 'line',
                data: { labels: mesesLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Georgia' } } }
                    }
                }
            });
        }

        function filtrarGrafico() {
            const limite = parseInt(document.getElementById('periodo').value);
            const luzFiltrada = dadosLuzBase.slice(-limite);
            
            const mesesValidos = luzFiltrada.map(l => l.mes_referencia);
            const pagamentosFiltrados = dadosPagamentosBase.filter(p => mesesValidos.includes(p.mes_referencia));

            renderizarGraficos(luzFiltrada, pagamentosFiltrados);
        }

        filtrarGrafico();
    </script>

</body>
</html>