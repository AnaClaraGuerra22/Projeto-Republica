<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Histórico - República 804</title>
    <link rel="icon" type="image/png" href="/imagens/logo.jpeg">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="republica-body">

    <nav class="glass-nav">
        <div class="logo">
            <img src="/imagens/logo.jpeg" alt="Logo">
            <span>República 804</span>
        </div>
        <div class="nav-links">
            <a href="/">Cálculo</a>
            <a href="/galeria">Momentos</a>
            <a href="/moradoras">Moradoras</a>
            <a href="/historico" class="active">Histórico</a> 
            <a href="/estatisticas">Estatísticas</a>
        </div>
    </nav>

    <main class="container">
        <section class="glass-card">
            <h2 class="section-title">Histórico de Fechamentos</h2>
            
            <table class="resultado-table">
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th>Luz (R$)</th>
                        <th>Total (R$)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (historico.length > 0) { %>
                        <% historico.forEach(f => { %>
                            <tr>
                                <td><%= f.mes_referencia %></td>
                                <td>R$ <%= f.valor_luz %></td>
                                <td><strong>R$ <%= f.valor_total_pago %></strong></td>
                                <td>
                                    <div style="display: flex; gap: 10px; justify-content: center;">
                                        <button class="btn-detalhes" title="Ver Detalhes" onclick="abrirDetalhes('<%= f.id %>', '<%= f.mes_referencia %>')">
                                            <i class="fa fa-eye"></i>
                                        </button>

                                        <form action="/historico/deletar/<%= f.id %>" method="POST" onsubmit="return confirm('Tem certeza que deseja apagar permanentemente este fechamento? Isso também removerá os dados das estatísticas.')">
                                            <button type="submit" class="btn-detalhes" title="Excluir" style="color: #e74c3c;">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #888;">Nenhum fechamento salvo ainda.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </section>
    </main>

    <div id="modalDetalhes" class="modal-overlay" style="display:none;">
        <div class="glass-card modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalTitulo" style="margin: 0; color: var(--accent-color);">Detalhes</h3>
                <button onclick="fecharModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888;">&times;</button>
            </div>
            
            <table class="resultado-table">
                <thead>
                    <tr>
                        <th>Moradora</th>
                        <th>Valor Pago</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaDetalhes">
                    </tbody>
            </table>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="fecharModal()" class="btn-primary" style="padding: 10px 20px;">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        async function abrirDetalhes(id, mes) {
            const corpoTabela = document.getElementById('corpoTabelaDetalhes');
            document.getElementById('modalTitulo').innerText = "Resumo: " + mes;
            corpoTabela.innerHTML = "<tr><td colspan='2' style='text-align:center;'>Carregando...</td></tr>";
            
            document.getElementById('modalDetalhes').style.display = 'flex';

            try {
                const resposta = await fetch('/historico/detalhes/' + id);
                const dados = await resposta.json();
                
                corpoTabela.innerHTML = "";
                
                if (dados.length === 0) {
                    corpoTabela.innerHTML = "<tr><td colspan='2'>Nenhum detalhe encontrado.</td></tr>";
                    return;
                }

                dados.forEach(item => {
                    corpoTabela.innerHTML += `
                        <tr>
                            <td>${item.nome}</td>
                            <td class="valor-destaque">R$ ${item.valor}</td>
                        </tr>
                    `;
                });
            } catch (err) {
                corpoTabela.innerHTML = "<tr><td colspan='2' style='color: red;'>Erro ao carregar dados.</td></tr>";
            }
        }

        function fecharModal() {
            document.getElementById('modalDetalhes').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modalDetalhes');
            if (event.target == modal) {
                fecharModal();
            }
        }
    </script>
</body>
</html>